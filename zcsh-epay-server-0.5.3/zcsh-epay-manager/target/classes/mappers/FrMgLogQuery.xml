<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.agre.modules.log.mapper.LogQueryMapper">

   <!-- 日志查询 -->
     <select id="queryByPage" parameterType="com.froad.agre.modules.log.vo.req.LogQueryVoReq" resultType="com.froad.agre.modules.log.vo.resp.LogQueryVoResp">
		<include refid="coreSql"/>
		<include refid="queryDynSql" /> 
    </select>  
    
    
    <sql id="coreSql">
	    SELECT 
		fl.LOGIN_NAME as userName,
		fl.ORG_NAME as subJgmName,
		fl.ROLE_NAME as roleType,
		to_char(fl.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') as operationTime,
		fl.REMARK as operationContext
		<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		        FROM FR_MG_LOG fl
		   </if>
		    <if test='queryType=="2"'>
		        FROM FR_MG_LOG_HIS fl
		   </if>
		 </if>
	</sql>
	<sql id = "queryDynSql">
		<where>
		fl.ORG_CODE IN
		(
		SELECT ORG_CODE 
		FROM  FR_ORG 
		WHERE ENABLE='0' 
		AND (ORG_CODE = #{JGM} OR CITY_ORG_CODE=#{JGM} OR PRO_ORG_CODE=#{JGM})
		)
		 <if test="userName !=null and userName!='' ">
		     AND fl.LOGIN_NAME  LIKE '%' || #{userName} || '%'
		 </if>
		 <if test="subJgm !=null and subJgm!='' ">
		    AND fl.ORG_CODE =#{subJgm}
		 </if>
		  <if test="intoSDate != null and intoSDate!='' ">
				<![CDATA[ AND  fl.CREATE_TIME  >= #{intoSDate}||' 00:00:00' ]]>
		</if>
			<if test="intoEDate != null and intoEDate!='' ">
			  	<![CDATA[ AND fl.CREATE_TIME <=#{intoEDate}||' 23:59:59' ]]>
		</if>
		 
		</where>
		ORDER BY FL.CREATE_TIME DESC
	</sql>
	<insert id="saveLog" parameterType="FrMgLog">
		insert into fr_mg_log(CREATE_TIME,LOGIN_NAME,USER_NAME,IP,ORG_CODE,ORG_NAME,ROLE_ID,ROLE_NAME,REMARK) 
		values(#{createTime},#{loginName},#{userName},#{ip},#{orgCode},#{orgName},#{roleId},#{roleName},#{remark})
		
	</insert>
  </mapper>