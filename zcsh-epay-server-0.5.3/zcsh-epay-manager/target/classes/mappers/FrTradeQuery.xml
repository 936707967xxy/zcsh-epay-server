<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.agre.modules.trade.mapper.TradeQueryMapper">

     <select id="queryTradeList" parameterType="com.froad.agre.modules.trade.vo.req.TradeQueryVoReq" resultType="com.froad.agre.modules.trade.vo.resp.TradeQueryVoResp">
		<include refid="coreSql"/>
		<include refid="queryDynSql" />
		<include refid="desc"/>
    </select>  
    
    <sql id="coreSql">
        SELECT 
        fo.ID as indexId,
		fo.ORDER_ID as orderNO ,
		fo.POINT_NO	as pointNo,	
		fm.MERCHANT_FULLNAME as merchantName,
		to_char(fo.CREATE_TIME,'YYYY-MM-DD HH24:MI:SS') as tradeTime,
		fo.TOTAL_MONEY as totalMoney,
		fo.TRADE_NO as tradeNo,
		fo.USER_ID as accountNo,
		fo.TRADE_CHANNEL as tradeType,
		fo.SOURCE_CHANNEL as requestChannelNo,
		fo.TYPE as payType,
		fo.bak1 as bak1,
		fo.ORDER_STATUS as tradeStatus,
        org.ORG_NAME as orgName,
        fr.OUTLET_NAME as outletName,
        nvl((select sum(PAY_CHANNEL_CHARGE)
        <if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		        from fr_order_bill 
		        where ORDER_ID=fo.ORDER_ID 
		        and TYPE='1' 
		         group by ORDER_ID ),0)as channelRate
		        FROM FR_ORDER as fo
		   </if>
		    <if test='queryType=="2"'>
		        from FR_ORDER_BILL_NINETY
		        where ORDER_ID=fo.ORDER_ID  
		        and TYPE='1' 
		        group by ORDER_ID ),0)as channelRate
		        FROM FR_ORDER_NINETY as fo
		   </if>
		    <if test='queryType=="3"'>
		        from FR_ORDER_BILL_HIS
		        where ORDER_ID=fo.ORDER_ID  
		        and TYPE='1' 
		        group by ORDER_ID ),0)as channelRate
		        FROM FR_ORDER_HIS as fo
		   </if>
		 </if>
		LEFT JOIN FR_MERCHANT fm on fo.MERCHANT_ID=fm.MERCHANT_ID
		LEFT JOIN FR_ORG org ON fo.THE_ORG_CODE=org.ORG_CODE
		LEFT JOIN FR_MERCHANT_OUTLET fr  ON fo.OUTLET_ID=fr.OUTLET_ID
	</sql>
	
	<sql id = "queryDynSql">
		<where>
		 fm.ORG_CODE in(
         SELECT ORG_CODE FROM  FR_ORG 
         WHERE ENABLE='0' and (ORG_CODE = #{JGM}
         OR CITY_ORG_CODE=#{JGM} or PRO_ORG_CODE=#{JGM}))
		 <if test="orderNO!=null and orderNO!='' ">
		   AND  fo.ORDER_ID = #{orderNO}
		 </if>
		 <if test="merchantName != null  and merchantName!='' ">
			AND fm.MERCHANT_FULLNAME  LIKE '%'||#{merchantName}||'%'
		</if>
		 <if test="payChannelNO!=null and payChannelNO!='' ">
		   AND (fo.TRADE_NO = #{payChannelNO} or fo.POINT_NO = #{payChannelNO})
		 </if>
		 <if test="subJgmName!=null and subJgmName!='' ">
		  AND(org.ORG_CODE =#{subJgmName}
          OR ORG.CITY_ORG_CODE=#{subJgmName}
          OR ORG.PRO_ORG_CODE=#{subJgmName})
		 </if>
		 <if test="tradeType !=null and tradeType!='' ">
		   AND fo.TRADE_CHANNEL = #{tradeType}
		 </if>
		 <if test="requestChannelNo !=null and requestChannelNo!='' ">
		   AND fo.SOURCE_CHANNEL IN('02','03')
		   AND fo.SOURCE_CHANNEL = #{requestChannelNo}
		 </if>
		 <if test="payType !=null and payType!='' ">
		   AND fo.TYPE = #{payType}
		 </if>
		 <if test="tradeStatus !=null and tradeStatus!='' ">
		 <!-- 交易状态不查询 status=1 -->
		   <if test='tradeStatus=="1"'>
		        AND  fo.ORDER_STATUS ='2'
		   </if>
		   <if test='tradeStatus!="1"'>
		       AND  fo.ORDER_STATUS =#{ tradeStatus}
		   </if>
		 </if>
		 <if test="intoSDate != null and intoSDate!='' ">
			<![CDATA[ and fo.CREATE_TIME >= #{intoSDate} ]]>
		</if>
		<if test="intoEDate != null and intoEDate!='' ">
		  	<![CDATA[ and fo.CREATE_TIME <=#{intoEDate} ]]>
		</if>
		 <if test="totalSMoney !=null and totalSMoney!='' ">
		   AND fo.TOTAL_MONEY >=#{ totalSMoney}
		 </if>
		 <if test="totalEMoney !=null and totalEMoney!='' ">
		   	<![CDATA[AND fo.TOTAL_MONEY <=#{ totalEMoney}]]>
		 </if>
		</where>
	</sql>
	
	<!-- 订单详细信息查询 -->
	<select id="queryDetails" parameterType="com.froad.agre.modules.trade.vo.req.TradeQueryVoReq" resultType="com.froad.agre.modules.trade.vo.resp.TradeQueryVoResp">
		SELECT distinct
		fo.TOTAL_MONEY as totalMoney,
		fo.POINT as integralPayMoney,
		fo.TRADE_CHANNEL as tradeType,
		fo.SOURCE_CHANNEL as requestChannelNo,
		fo.ORDER_STATUS as tradeStatus,
		fo.TRADE_NO as tradeNo,
		fo.POINT_NO as pointNo,
		fo.TYPE as payType,
		fo.USER_ID as accountNo,
		to_char(fo.CREATE_TIME,'YYYY-MM-DD HH24:MI:SS') as tradeTime,
		fo.TRADE_NO as payChannelNO,
		fr.OUTLET_NAME as outletName,
		fm.MERCHANT_FULLNAME as corMerchantName,
		org.ORG_NAME as corBank,
		fo.ORDER_ID as merchantOrderNO,
		fo.bak1 as bak1,
		fo.TERMINAL_ID as terminalId,
		nvl((select sum(PAY_CHANNEL_CHARGE)
		<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
			     FROM fr_order_bill where ORDER_ID=fo.ORDER_ID 
			     and TYPE='1' 
			      group by ORDER_ID ),0)as channelRate
			     FROM FR_ORDER AS fo
		   </if>
		    <if test='queryType=="2"'>
		        FROM FR_ORDER_BILL_NINETY where ORDER_ID=fo.ORDER_ID 
		        and TYPE='1' 
		         group by ORDER_ID ),0)as channelRate
			    FROM FR_ORDER_NINETY AS fo
		   </if>
		    <if test='queryType=="3"'>
		        FROM FR_ORDER_BILL_HIS where ORDER_ID=fo.ORDER_ID 
		        and TYPE='1' 
		         group by ORDER_ID ),0)as channelRate
			    FROM FR_ORDER_HIS AS fo
		   </if>
		 </if>
		LEFT JOIN FR_MERCHANT_OUTLET fr  ON fo.OUTLET_ID=fr.OUTLET_ID
		LEFT JOIN FR_MERCHANT fm    ON fo.MERCHANT_ID=fm.MERCHANT_ID
		LEFT JOIN FR_ORG org ON fm.ORG_CODE=org.ORG_CODE
		WHERE 
		<if test="orderNO!=null and orderNO!='' ">
		fo.ORDER_ID = #{orderNO}
		</if>
		<if test="indexId!=null and indexId!='' ">
		AND fo.ID=#{indexId}
		</if>
    </select> 
    
    <!-- 下载交易表 -->
     <select id="downloadTradeList" parameterType="com.froad.agre.modules.trade.vo.req.TradeQueryVoReq" resultType="com.froad.agre.modules.trade.vo.resp.TradeQueryVoResp">
		<include refid="coreSql"/>
		<include refid="queryDynSql" /> 
		<include refid="desc" /> 
    </select>  
    <!-- 导出结果按照交易时间倒叙排列,最大导出50000条 -->
    <sql id="desc">
      ORDER BY fo.CREATE_TIME DESC 
    </sql>
  </mapper>