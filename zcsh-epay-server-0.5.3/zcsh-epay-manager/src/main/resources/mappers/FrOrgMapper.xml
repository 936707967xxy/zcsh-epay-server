<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.agre.modules.organization.mapper.FrOrgMapper">
  <resultMap id="BaseResultMap" type="com.froad.agre.modules.organization.po.FrOrg">
    <id column="ID" jdbcType="BIGINT" property="id" />
    <result column="CREATE_TIME" jdbcType="TIMESTAMP" property="createTime" />
    <result column="UPDATE_TIME" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="ORG_CODE" jdbcType="VARCHAR" property="orgCode" />
    <result column="ORG_NAME" jdbcType="VARCHAR" property="orgName" />
    <result column="CITY_ORG_CODE" jdbcType="VARCHAR" property="cityOrgCode" />
    <result column="PRO_ORG_CODE" jdbcType="VARCHAR" property="proOrgCode" />
    <result column="PHONE" jdbcType="VARCHAR" property="phone" />
    <result column="ADDRESS" jdbcType="VARCHAR" property="address" />
    <result column="ENABLE" jdbcType="CHAR" property="enable" />
  </resultMap>
  <sql id="Base_Column_List">
    ID, CREATE_TIME, UPDATE_TIME, ORG_CODE, ORG_NAME, CITY_ORG_CODE, PRO_ORG_CODE, PHONE, ADDRESS
    ENABLE
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from FR_ORG
    where ID = #{id,jdbcType=BIGINT}
  </select>
  
  <select id="selectByOrgCode" parameterType="QueryOrgListVoReq" resultType="QueryOrgVoResp">
	SELECT ID as id ,CREATE_TIME as createTime, UPDATE_TIME as updateTime,COALESCE(ORG_CODE,'') as orgCode,
	COALESCE(ORG_NAME,'') as orgName, 
	COALESCE(CITY_ORG_CODE,'') as cityOrgCode,    
	COALESCE((SELECT ORG_NAME FROM FR_ORG o WHERE o.org_code=t.CITY_ORG_CODE),'') AS cityOrgName,
    COALESCE(PRO_ORG_CODE,'') as proOrgCode,
    COALESCE((SELECT ORG_NAME FROM FR_ORG o WHERE o.org_code=t.PRO_ORG_CODE),'') AS proOrgName,
    PHONE as phone,ADDRESS as address FROM FR_ORG t
	<where>
		t.ENABLE='0'
		<if test="userOrgCode != null and userOrgCode != ''">
			and (t.ORG_CODE = #{userOrgCode} or t.CITY_ORG_CODE=#{userOrgCode} or t.PRO_ORG_CODE=#{userOrgCode})
		</if>
		<if test="orgCode != null and orgCode != ''">
			and t.ORG_CODE = #{orgCode}
		</if>
		<if test="orgName != null and orgName != ''">
			and t.ORG_NAME  LIKE '%' || #{orgName} || '%'
		</if>
		<if test="orgType != null and orgType != ''">
			<!-- 1:省联社：此时PRO_ORG_CODE、 CITY_ORG_CODE均为空-->
			<if test="orgType==1">
				and ((t.CITY_ORG_CODE is null or t.CITY_ORG_CODE='') and (t.PRO_ORG_CODE is null or t.PRO_ORG_CODE=''))
			</if>
			<!-- 2:法人行： 此时PRO_ORG_CODE不为空，CITY_ORG_CODE为空-->
			<if test="orgType==2">
				and ((t.PRO_ORG_CODE is not null and t.PRO_ORG_CODE!='') and (t.CITY_ORG_CODE is null or t.CITY_ORG_CODE=''))
			</if>
			<!-- 3:网点：此时 CITY_ORG_CODE、PRO_ORG_CODE均不为空-->
			<if test="orgType==3">
				and ((t.CITY_ORG_CODE is not null and t.CITY_ORG_CODE!='') and (t.PRO_ORG_CODE is not null and t.PRO_ORG_CODE!=''))
			</if>
		</if>
		<if test="level != null and level != ''">
			<!-- 1:省联社：此时PRO_ORG_CODE、 CITY_ORG_CODE均为空-->
			<if test="level==1">
				and (t.PRO_ORG_CODE = #{theOrgCode} and (t.CITY_ORG_CODE is null or t.CITY_ORG_CODE=''))
			</if>
			<!-- 2:法人行： 此时PRO_ORG_CODE不为空，CITY_ORG_CODE为空-->
			<if test="level==2">
				and (t.CITY_ORG_CODE = #{theOrgCode} and (t.CITY_ORG_CODE is not null and t.CITY_ORG_CODE!='') and (t.PRO_ORG_CODE is not null and t.PRO_ORG_CODE!=''))
			</if>
			<!-- 3:网点：此时 CITY_ORG_CODE、PRO_ORG_CODE均不为空-->
			<if test="level==3">
				and t.ORG_CODE = #{theOrgCode}
			</if>
		</if>
	</where>
  </select>
  	<select id="selectByOrgSelfCode" parameterType="QueryOrgListVoReq" resultType="QueryOrgTreeVoResp">
  		SELECT 
		org_code as orgCode,
		org_name orgName,
		'' as parentOrgCode
	    FROM FR_ORG where org_code=#{userOrgCode}
  	</select>
	<select id="selectByOrgCurCode" parameterType="QueryOrgListVoReq" resultType="QueryOrgTreeVoResp">
		SELECT 
		COALESCE(t.ORG_CODE,'') as orgCode,
		COALESCE(t.ORG_NAME,'') as orgName,
		${userOrgCode} as parentOrgCode
	    FROM FR_ORG t
	    <where>
			t.ENABLE='0'
			<if test="userOrgCode != null and userOrgCode != ''">
				and (t.ORG_CODE = #{userOrgCode} or t.CITY_ORG_CODE=#{userOrgCode} or t.PRO_ORG_CODE=#{userOrgCode})
			</if>
			<if test="orgType != null and orgType != ''">
				<!-- 1:省联社：此时PRO_ORG_CODE、 CITY_ORG_CODE均为空-->
				<if test="orgType==1">
					and ((t.CITY_ORG_CODE is null or t.CITY_ORG_CODE='') and (t.PRO_ORG_CODE is null or t.PRO_ORG_CODE=''))
				</if>
				<!-- 2:法人行： 此时PRO_ORG_CODE不为空，CITY_ORG_CODE为空-->
				<if test="orgType==2">
					and ((t.PRO_ORG_CODE is not null and t.PRO_ORG_CODE!='') and (t.CITY_ORG_CODE is null or t.CITY_ORG_CODE=''))
				</if>
				<!-- 3:网点：此时 CITY_ORG_CODE、PRO_ORG_CODE均不为空-->
				<if test="orgType==3">
					and ((t.CITY_ORG_CODE is not null and t.CITY_ORG_CODE!='') and (t.PRO_ORG_CODE is not null and t.PRO_ORG_CODE!=''))
				</if>
			</if>
		</where>
  	</select>
  	
  	<!-- 机构管理 删除机构信息 -->
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from FR_ORG
    where ORG_CODE = #{orgCode}
  </delete>
  
  <!-- 机构管理  新增机构信息 -->
  <insert id="insert" parameterType="FrOrg">
    insert into FR_ORG (ID, CREATE_TIME, UPDATE_TIME, 
      ORG_CODE, ORG_NAME, CITY_ORG_CODE, 
      PRO_ORG_CODE, PHONE, ENABLE,ADDRESS,BAK1,BAK2,BAK3,BAK4,BAK5,BAK6
      )
    values (#{id}, #{createTime}, #{updateTime}, 
      #{orgCode}, #{orgName}, #{cityOrgCode}, 
      #{proOrgCode}, #{phone}, #{enable}, #{address},
      #{bak1}, #{bak2}, #{bak3}, #{bak4}, #{bak5}, #{bak6}
      )
  </insert>
  
  
  <insert id="insertSelective" parameterType="FrOrg">
    insert into FR_ORG
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        ID,
      </if>
      <if test="createTime != null">
        CREATE_TIME,
      </if>
      <if test="updateTime != null">
        UPDATE_TIME,
      </if>
      <if test="orgCode != null">
        ORG_CODE,
      </if>
      <if test="orgName != null">
        ORG_NAME,
      </if>
      <if test="cityOrgCode != null">
        CITY_ORG_CODE,
      </if>
      <if test="proOrgCode != null">
        PRO_ORG_CODE,
      </if>
      <if test="phone != null">
        PHONE,
      </if>
      <if test="address != null">
        ADDRESS,
      </if>
      <if test="enable != null">
        ENABLE,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="orgCode != null">
        #{orgCode,jdbcType=VARCHAR},
      </if>
      <if test="orgName != null">
        #{orgName,jdbcType=VARCHAR},
      </if>
      <if test="cityOrgCode != null">
        #{cityOrgCode,jdbcType=VARCHAR},
      </if>
      <if test="proOrgCode != null">
        #{proOrgCode,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        #{phone,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        #{address,jdbcType=VARCHAR},
      </if>
      <if test="enable != null">
        #{enable,jdbcType=CHAR},
      </if>
    </trim>
  </insert>
  
  <update id="updateByPrimaryKeySelective" parameterType="FrOrg">
    update FR_ORG
    <set>
      <if test="createTime != null">
        CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null">
        UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="orgCode != null">
        ORG_CODE = #{orgCode,jdbcType=VARCHAR},
      </if>
      <if test="orgName != null">
        ORG_NAME = #{orgName,jdbcType=VARCHAR},
      </if>
      <if test="cityOrgCode != null">
        CITY_ORG_CODE = #{cityOrgCode,jdbcType=VARCHAR},
      </if>
      <if test="proOrgCode != null">
        PRO_ORG_CODE = #{proOrgCode,jdbcType=VARCHAR},
      </if>
      <if test="phone != null">
        PHONE = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        ADDRESS = #{address,jdbcType=VARCHAR},
      </if>
      <if test="enable != null">
        ENABLE = #{enable,jdbcType=CHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=BIGINT}
  </update>
  
  <!-- 机构管理 机构信息修改 -->
  <update id="updateByPrimaryKey" parameterType="FrOrg">
	  update FR_ORG
	  SET UPDATE_TIME = #{updateTime},
      ORG_NAME = #{orgName},
      PHONE = #{phone},
      ADDRESS = #{address},
      ENABLE = #{enable}
      where ORG_CODE = #{orgCode}
  </update>
  
  
  <!-- 根据用户登录的机构编码判断是否为省行社用户 -->
  <select id="queryOrgUser" parameterType="com.froad.agre.modules.organization.po.FrOrg" resultMap="BaseResultMap">
	  SELECT 
	  ORG_CODE, CITY_ORG_CODE, PRO_ORG_CODE,ORG_NAME
	  FROM FR_ORG
	  WHERE  ORG_CODE = #{orgCode}
  </select>
  
  <!-- 统计机构总数 -->
  <select id="getOrgCount" parameterType="com.froad.agre.modules.organization.po.FrOrg"  resultType="com.froad.agre.modules.organization.vo.resp.QueryOrgVoResp">
           SELECT ID as id  FROM  FR_ORG ORDER BY ID DESC
  </select>
  
  <select id="validateOrgInfo" parameterType="java.lang.String"  resultType="com.froad.agre.modules.organization.vo.resp.QueryOrgVoResp">
          SELECT 
          CITY_ORG_CODE as cityOrgCode,
          PRO_ORG_CODE as proOrgCode
          FROM  FR_ORG 
          WHERE 
          ORG_CODE=#{orgCode}
  </select>
  
  
  <!-- 获取不同机构下的用户数量 -->
  <select id="getOrgMerchantCount" parameterType="java.lang.String" resultType="com.froad.agre.modules.organization.vo.resp.QueryOrgVoResp">
       SELECT org.ORG_NAME as orgName
		FROM
		FR_MERCHANT_CHANNEL fc
		LEFT JOIN FR_MERCHANT fm ON  fc.MERCHANT_ID=fm.MERCHANT_ID
		LEFT JOIN FR_ORG org ON fm.ORG_CODE=org.ORG_CODE
		WHERE fm.IS_DELETE='0' AND fm.status='1' AND fc.STATUS='1'
		AND org.ORG_CODE=#{orgCode}
  </select>
  
  <!-- 获取省级信息 -->
  <select id="queryProvicePk" parameterType="java.lang.String" resultType="com.froad.agre.modules.organization.vo.resp.QueryProviceResp">
        SELECT 
		trim(f.PROVINCEID) as proviceValue,
		trim(f.PROVINCE) as  proviceName
        FROM FR_MG_PROVINCES f WHERE PROVINCEID=#{Code}
  </select>
  <!-- 获取市级信息 -->
  <select id="queryCityPk" parameterType="java.lang.String" resultType="com.froad.agre.modules.organization.vo.resp.QueryCityResp">
        SELECT 
        c.CITYID as cityValue,
        c.CITY as   cityName
        FROM FR_MG_CITY  c WHERE c.PROVINCEID=#{Code} 
  </select>
  <!-- 获取县级信息 -->
  <select id="queryAdressPk" parameterType="java.lang.String" resultType="com.froad.agre.modules.organization.vo.resp.QueryAddressResp">
       SELECT 
	   a.AREA as  areaName,
	   a.AREAID as areaValue
	   FROM FR_MG_AREAS  a WHERE a.CITYID=#{Code}
  </select>
  
  <!-- 根据机构码查询此机构是否存在 -->
  <select id="queryOrgIsNo" parameterType="java.lang.String" resultType="com.froad.agre.modules.organization.vo.resp.QueryOrgVoResp">
      SELECT ORG_CODE as orgCode  FROM FR_ORG WHERE ORG_CODE=#{Code}
  </select>
  
  <select id="querySubOrgList" parameterType="com.froad.agre.modules.organization.vo.req.QueryOrgListVoReq" 
                 resultType="com.froad.agre.modules.organization.vo.resp.QuerySubOrgResp">
      SELECT 
      org.ORG_CODE as orgCode,
      org.ORG_NAME as orgName
      FROM FR_ORG org
      <where>
      <if test="orgType != '01' ">
       org.PRO_ORG_CODE=''  AND org.CITY_ORG_CODE=''
      </if>
      <if test="orgType != '00' ">
       org.PRO_ORG_CODE!=''  AND org.CITY_ORG_CODE=''
      </if>
      </where>
  </select>
</mapper>