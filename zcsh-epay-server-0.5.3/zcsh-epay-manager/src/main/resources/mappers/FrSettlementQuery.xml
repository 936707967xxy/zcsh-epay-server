<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.agre.modules.settlement.mapper.SettlementQueryMapper">

   <!-- 第三方渠道结算查询 -->
     <select id="querySettlementList" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementQueryVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementQueryVoResp">
		<include refid="coreSql"/>
    </select>  
    
    <sql id="coreSql">
        select * from(
		select 
		settlementDate,tradeType,LISTAGG(settle_status,',') WITHIN GROUP (ORDER BY SETTLE_STATUS asc) as settlementStatus,
		sum(settlementMoney) as settlementMoney,
		max(settlementTime) as settlementTime,
		max(settlementBetween) as settlementBetween,
		sum(successSettlementAmt) as successSettlementAmt,
		sum(bankRate) as bankRate,
		sum(payChannelRate) as payChannelRate,
		sum(merchantShoutAmt) as merchantShoutAmt
		FROM(
		SELECT 
		fb.SETTLE_DATE as settlementDate,
		fb.PAY_CHANNEL as tradeType,
        fb.SETTLE_STATUS,
		sum(fb.AMT) as settlementMoney,
		to_char(max(fb.INFO_TIME)) as settlementTime,
		to_char(min(fb.SETTLE_DATA_DATE)) as settlementBetween,		
		sum(nvl(fb.FACT_MONEY,0)) as successSettlementAmt,
		sum(nvl(fb.CHARGE,'0') ) as bankRate, 
		sum(nvl(fb.CHL_CHARGE,'0') ) as payChannelRate, 
		sum(nvl(fb.SHOULD_AMT,'0') ) as merchantShoutAmt
		<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		       FROM FR_SETTLE_MERCHANT_BILL fb
		   </if>
		    <if test='queryType=="3"'>
		       FROM FR_SETTLE_MERCHANT_BILL_HIS fb
		   </if>
		 </if>
        where 
	    fb.PAY_CHANNEL IN('00','01')
	    <if test="tradeType !=null and tradeType!='' ">
		   		AND fb.PAY_CHANNEL = #{tradeType}
		</if>
		<if test="intoSDate != null and intoSDate!='' ">
			<![CDATA[ AND fb.SETTLE_DATE>=#{intoSDate}]]>
		</if>
		<if test="intoEDate != null and intoEDate!='' ">
		  	<![CDATA[  AND fb.SETTLE_DATE<=#{intoEDate}]]>
		</if>
        GROUP BY fb.SETTLE_DATE,fb.PAY_CHANNEL,fb.SETTLE_STATUS
		ORDER BY fb.SETTLE_DATE DESC) 
         group by settlementDate,tradeType)
         <if test="settlementStatus !=null and settlementStatus!='' ">
             <!-- 待结算 -->
	   	<if test='settlementStatus=="0"'>
	   		    where settlementStatus = '0'
	   	</if>
	   	<!-- 结算失败 -->
	   	 <if test='settlementStatus=="3"'>
	   		where settlementStatus = '2' 
	   	</if>
	   	<if test='settlementStatus=="1"'>
	   	     where  settlementStatus = '1' 
	   	</if>
	   	<if test='settlementStatus=="2"'>
	   	     where length(settlementStatus)>1 
	   	</if>
	   	</if>
	</sql>
	
	
	<!-- 第三方渠道商户明细查询 -->
	<select id="querySettlementDetails" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementQueryVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementQueryVoResp">
	  <include refid="coreSettlementsql"/>
	</select>
     <sql id="coreSettlementsql">
        SELECT 
		fb.ID as indexId,
		fb.MERCHANT_ID as merchantId,
		fm.MERCHANT_FULLNAME as merchantName,
		nvl(fb.SHOULD_AMT,'0') as settShGetMoney,
		nvl(fb.FACT_MONEY,'0') as settShRealGetMoney,
		nvl(fb.CHARGE,'0') as bankRate,
		nvl(fb.PROFIT,'0') as profitMoney,
		fb.SETTLE_STATUS as merchantSatatus,
		fb.SETTLE_TYPE as merchantSettlType,
		nvl(fb.AMT,'0') as AMT
		<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		       FROM FR_SETTLE_MERCHANT_BILL fb
		   </if>
		    <if test='queryType=="3"'>
		       FROM FR_SETTLE_MERCHANT_BILL_HIS fb
		   </if>
		 </if>
		LEFT JOIN FR_MERCHANT fm ON fb.MERCHANT_ID=fm.MERCHANT_ID
		<where>
			fm.ORG_CODE  IN ( SELECT ORG_CODE FROM FR_ORG WHERE ENABLE='0' AND (ORG_CODE = #{JGM} OR CITY_ORG_CODE=#{JGM} OR PRO_ORG_CODE=#{JGM}))
			<if test="merchantName !=null and merchantName!='' ">
			   AND fm.MERCHANT_FULLNAME  LIKE '%'||#{merchantName}||'%'
			</if>
			<if test="intoSDate !=null and intoSDate!='' ">
			  AND fb.SETTLE_DATE = #{intoSDate}
			</if>
			<if test="tradeType !=null and tradeType!='' ">
			    AND fb.PAY_CHANNEL= #{tradeType}
			</if>
			<if test="merchantSettlType !=null and merchantSettlType!='' ">
			    AND fb.SETTLE_TYPE= #{merchantSettlType}
			</if>
			
			<if test="merchantSatatus !=null and merchantSatatus!='' ">
			    AND fb.SETTLE_STATUS= #{merchantSatatus}
			</if>
			
		</where>
     </sql>
    
    <select id="querySettleTradeMoney" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementQueryVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementTradeMoneyVoResp">
    	SELECT COALESCE(SUM(FS.SHOULD_AMOUNT),0) AS realGetMoney, 
    	COALESCE(SUM(FS.SETTLE_AMOUNT),0) as putMoney,
    	COALESCE(SUM(FOB.PAY_CHANNEL_CHARGE),0) AS totalChanelCharge, COALESCE(SUM(FOB.BANK_CHARGE),0) AS totalBankCharge
        <if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		       FROM FR_SETTLE FS
               LEFT JOIN FR_ORDER fo ON fs.ORDER_ID=fo.ORDER_ID
               LEFT JOIN FR_ORDER_BILL FOB ON FS.SEQ_ID=FOB.SEQ_ID
		   </if>
		    <if test='queryType=="3"'>
		      FROM FR_SETTLE_HIS FS
	          LEFT JOIN FR_ORDER_HIS fo ON fs.ORDER_ID=fo.ORDER_ID
	          LEFT JOIN FR_ORDER_BILL_HIS  FOB ON FS.SEQ_ID=FOB.SEQ_ID
		   </if>
		 </if>
        WHERE TO_CHAR(FS.SHOULD_DAY,'YYYY-MM-DD') = #{intoSDate} AND FS.PAY_CHANNEL= #{tradeType} and FOB.DZ_STATUS=#{dzStatus}
        AND fo.ORG_CODE IN ( SELECT ORG_CODE FROM FR_ORG WHERE ENABLE='0' AND (ORG_CODE = #{JGM} OR CITY_ORG_CODE=#{JGM} OR PRO_ORG_CODE=#{JGM}))
    </select>
    
    <!-- 行内渠道结算查询列表 -->
     <select id="querySettlementBankList" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementBankVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementQueryVoResp">
		<include refid="coreSqlBank"/>
		<include refid="queryDynBankSql" /> 
    </select>  
    <sql id="coreSqlBank">
		SELECT 
        fs.ORDER_ID as orderNO,
		fs.SETTLE_ID as settlementNO,
		fm.MERCHANT_FULLNAME as merchantName,
		fs.SETTLE_AMOUNT as settlementMoney,
		to_char(fs.SHOULD_DAY,'yyyy-MM-dd HH24:mi:ss') as settlementDate,
		fs.SETTLE_STATUS as settlementStatus
		FROM FR_SETTLE fs
		LEFT JOIN FR_MERCHANT fm ON fs.MERCHANT_ID=fm.MERCHANT_ID
	</sql>
	<sql id = "queryDynBankSql">
		<where>
		 fs.PAY_CHANNEL IN('03','04')
		 AND fm.ORG_CODE IN
			(
			SELECT ORG_CODE 
			FROM  FR_ORG 
			WHERE ENABLE='0' 
			AND (ORG_CODE = #{JGM} OR CITY_ORG_CODE=#{JGM} OR PRO_ORG_CODE=#{JGM})
			)
		 <if test="orderNO !=null and orderNO!='' ">
		   AND fs.ORDER_ID = #{orderNO}
		 </if>
		 <if test="intoSDate != null and intoSDate!='' ">
				<![CDATA[ and fs.SHOULD_DAY  >= #{intoSDate} ]]>
		</if>
		<if test="intoEDate != null and intoEDate!='' ">
			  	<![CDATA[ and fs.SHOULD_DAY <=#{intoEDate} ]]>
		</if>
		 <if test="settlementStatus ==null or settlementStatus=='' ">
		  AND fs.SETTLE_STATUS IN ('1','2')
		 </if>
		 <if test="settlementStatus !=null and  settlementStatus!='' ">
		  AND fs.SETTLE_STATUS =#{settlementStatus}
		 </if>
		 ORDER BY fs.SHOULD_DAY DESC
		</where>
	</sql>
	
	<!-- 第三方渠道结算下载 -->
	<select id="downloadSettlList" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementQueryVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementQueryVoResp">
		<include refid="coreSql"/>
    </select> 
    
    <!-- 第三方渠道商户明细下载 -->
	<select id="downloadSettlMerchantList" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementQueryVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementMerchantDownloadVoResp">
		 <include refid="coreSettlementsql"/>
    </select> 
    
    <!-- 第三方渠道行内渠道下载 -->
	<select id="downloadSettlBankList" parameterType="com.froad.agre.modules.settlement.vo.req.SettlementQueryVoReq" resultType="com.froad.agre.modules.settlement.vo.resp.SettlementBankDownloadVoResp">
		<include refid="coreSqlBank"/>
		<include refid="queryDynBankSql" /> 
    </select> 
  </mapper>