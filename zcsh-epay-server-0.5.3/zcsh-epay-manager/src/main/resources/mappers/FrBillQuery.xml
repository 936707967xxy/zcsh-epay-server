<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.froad.agre.modules.bill.mapper.BillQueryMapper">

   <!-- 日账单查询列表 -->
     <select id="queryBillList" parameterType="com.froad.agre.modules.bill.vo.req.BillQueryVoReq" resultType="com.froad.agre.modules.bill.vo.resp.BillQueryVoResp">
		<include refid="coreSql"/>
		<include refid="queryDynSql" /> 
		<include refid="order" /> 
    </select> 
    
    
    <sql id="coreSql">
    SELECT 
	fr.FILE_DATE as billDate,
	fr.CHANNEL_ID as tradeType,
	fr.DZ_RESULT as reconResult,
	fr.ORDER_AMOUNT as receiveMoney,
	fr.SETTLE_AMOUNT as checkoutMoney,
	fr.SETTLE_STATUS as settlementStatus,
	fr.SETTLE_DATE as settlementDate,
	fr.FILE_URL as payChannelBill
	 from FR_DZ_FILE_FETCH fr
	</sql>
	<sql id = "queryDynSql">
		<where>
		      1=1
			<if test="billDate !=null and billDate!='' ">
		     AND fr.FILE_DATE = #{billDate}
			</if>
			<if test="tradeType!=null  and tradeType!='' ">
			  AND fr.CHANNEL_ID = #{tradeType}
			</if>
			<if test="reconResult!=null and reconResult!='' ">
			  AND fr.DZ_RESULT = #{reconResult}
			</if>
			 <if test="intoSDate != null and intoSDate!='' ">
				<![CDATA[ and fr.FILE_DATE  >= #{intoSDate} ]]>
			</if>
			<if test="intoEDate != null and intoEDate!='' ">
			  	<![CDATA[ and fr.FILE_DATE <=#{intoEDate} ]]>
			</if>
		</where>
	</sql>
	<sql id = "order">
		order by fr.FILE_DATE desc
	</sql>
	
	
	<!-- 日账单详细信息查询 -->
	<select id="queryBillDetails" parameterType="com.froad.agre.modules.bill.vo.req.BillDetailsQueryVoReq" resultType="com.froad.agre.modules.bill.vo.resp.BillQueryVoResp">
		SELECT 
		fr.CHN_PAY_NO AS payChannelNO,
		fr.ORDER_ID AS systemNO,
		fr.THIRD_AMOUNT AS payChannelMoney,
		fr.FROAD_AMOUNT AS systemMoney,
		fr.TYPE AS billType,
		fr.RECON_STATUS AS reconResult,
		fr.RECON_STATUS AS errorMessage,
		fr.DEAL_STATUS AS cerrentStatus,
		fr.DEAL_REMARK AS apare,
        fr.PAY_CHANNEL AS tradeType,
        fo.SOURCE_CHANNEL AS requestChannelNo,
        fr.FILE_DATE AS billDate
        <if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		       FROM FR_RECON fr
               LEFT JOIN FR_ORDER fo ON fr.ORDER_ID=fo.ORDER_ID
		   </if>
		    <if test='queryType=="2"'>
		       FROM FR_RECON_NINETY fr
               LEFT JOIN FR_ORDER_NINETY fo ON fr.ORDER_ID=fo.ORDER_ID
		   </if>
		    <if test='queryType=="3"'>
		      FROM FR_RECON_HIS fr
              LEFT JOIN FR_ORDER_HIS fo ON fr.ORDER_ID=fo.ORDER_ID
		   </if>
		 </if>
		<where>
		    1=1
		<if test="billDate !=null and billDate!=''">
		    AND fr.FILE_DATE = #{billDate}
		</if>
		<if test="billType !=null and billType!='' ">
			AND fr.TYPE =#{billType}
		</if>
		<if test="payChannelNO !=null and payChannelNO!=''">
		  AND fr.CHN_PAY_NO =#{payChannelNO}
		</if>
		<if test="requestChannelNo !=null and requestChannelNo!=''">
		  AND fo.SOURCE_CHANNEL IN('02','03')
		  AND fo.SOURCE_CHANNEL =#{requestChannelNo}
		</if>
		<if test="systemNO !=null and systemNO!=''" >
			AND fr.ORDER_ID =#{systemNO}
		</if>
		 <if test="reconResult!=null or reconResult!='' ">
			 <if test='reconResult=="1"'>
			     AND fr.RECON_STATUS ='OK'
			  </if>
			  <if test='reconResult=="0"' >
		         AND fr.RECON_STATUS !='OK'
		  </if>
		 </if>
		<if test="errorMessage !=null and errorMessage!='' ">
		 <if test='errorMessage=="00" '>
			     AND fr.RECON_STATUS ='OK'
			  </if>
			  <if test='errorMessage=="01" ' >
		         AND fr.RECON_STATUS = 'EF'
		      </if>
			  <if test='errorMessage=="02"' >
		         AND fr.RECON_STATUS = 'ET'
		      </if>
			  <if test='errorMessage=="03"' >
		         AND fr.RECON_STATUS = 'EL'
		      </if>
			  <if test='errorMessage=="04"' >
		         AND fr.RECON_STATUS ='ES'
		      </if>
		</if>
		<if test="cerrentStatus !=null and cerrentStatus!='' ">
			AND fr.DEAL_STATUS =#{cerrentStatus}
		</if>
		<if test="tradeType !=null and tradeType!='' ">
			AND fr.PAY_CHANNEL =#{tradeType}
		</if>
		<if test="createTime !=null and createTime!='' ">
			AND fr.FILE_DATE =#{createTime}
		</if>
		ORDER BY fr.CREATE_TIME,fr.ORDER_ID DESC
		</where>
    </select> 
    
    
    <!-- 差错账单查询 -->
     <select id="queryErrorBillDetails" parameterType="com.froad.agre.modules.bill.vo.req.BillErrorReq" resultType="com.froad.agre.modules.bill.vo.resp.BillErrorResp">
        <include refid="settlmentBillErrorAllSql_select"/>
	   <include refid="settlmentBillErrorAllSql_where"/>
    </select>  
    
    
	<!-- 结算模块差错账单导出 -->
	<select id="downloadDownloadBillErrorAll" parameterType="com.froad.agre.modules.bill.vo.req.BillErrorReq" resultType="com.froad.agre.modules.bill.vo.resp.BillErrorResp">
	   <include refid="settlmentBillErrorAllSql_select"/>
	   <include refid="settlmentBillErrorAllSql_where"/>
	</select>
    
    <sql id="settlmentBillErrorAllSql_select">
        SELECT * FROM(
        SELECT
		FB.ID                  AS INDEXID,
		FB.SETTLE_DATE         AS SETTLMENTDATE,
		FB.MERCHANT_ID         AS MERCHANTNO,
        (SELECT MERCHANT_FULLNAME FROM FR_MERCHANT WHERE MERCHANT_ID=FB.MERCHANT_ID)AS MERCHANTNAME,
        (SELECT ORG_NAME FROM FR_ORG WHERE ORG_CODE =(
        SELECT CITY_ORG_CODE FROM FR_MERCHANT WHERE MERCHANT_ID=FB.MERCHANT_ID))AS orgName,
		FB.PAY_CHANNEL         AS PAYCHANNELNO,
		NVL(FB.SHOULD_AMT,'0') AS MERCHANTSHOUDAMT,
		NVL(FB.AMT,'0')        AS MERCHANTREALAMT,
		NVL(FB.CHARGE,'0')     AS BANKRATE,
		NVL(FB.PROFIT,'0')     AS NETPROFIT,
		FB.SETTLE_TYPE         AS DELTYPE,
		FB.PAY_ACCT_JGM         AS ISHISTORY,
		FB.SETTLE_STATUS       AS MERCHANTSETTLMENTSTATUS,
		FB.SETTLE_TYPE         AS SETTLMENTTYPE
		FROM
		<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		       FR_SETTLE_MERCHANT_BILL FB 
		   </if>
		    <if test='queryType=="3"'>
		       FR_SETTLE_MERCHANT_BILL_HIS FB 
		   </if>
		 </if>
		WHERE
		(FB.SETTLE_STATUS='2' OR FB.SETTLE_TYPE IN('2'))
		<if test="orgCode!=null and orgCode!='' ">
		 AND FB.MERCHANT_ID
		 IN(
		 SELECT MERCHANT_ID FROM FR_MERCHANT WHERE ORG_CODE IN(
		 SELECT ORG_CODE FROM FR_ORG 
		 WHERE ENABLE='0'
		 AND ORG_CODE=#{orgCode} OR CITY_ORG_CODE=#{orgCode}
		 ))
		  </if>
	    )
    </sql>
    <sql id="settlmentBillErrorAllSql_where">
    <where>
        <if test="merchantName != null and merchantName!=''">
				and MERCHANTNAME  LIKE '%' || #{merchantName} || '%'
		</if>
		<if test="intoSDate != null and intoSDate!='' ">
				<![CDATA[ and SETTLMENTDATE >= #{intoSDate}]]>
		</if>
		<if test="intoEDate != null and intoEDate!='' ">
			  	<![CDATA[ and SETTLMENTDATE <=#{intoEDate} ]]>
		</if>
		<if test="payChannelNo != null and payChannelNo!=''">
				and PAYCHANNELNO=#{payChannelNo}
		</if>
		<if test="delType != null and delType!=''">
		  <if test='delType=="1"'>
	   		    and SETTLMENTTYPE='1' 
	     </if>
		  <if test='delType=="2"'>
	   		    and  SETTLMENTTYPE='2'
	     </if>
		  
		</if>
		</where>
    </sql>
    
    
    
    
    
    <!-- 下载账单信息 -->
     <select id="queryDownloadBillList" parameterType="com.froad.agre.modules.bill.vo.req.BillQueryVoReq" resultType="com.froad.agre.modules.bill.vo.resp.BillQueryVoResp">
		<include refid="coreSql"/>
		<include refid="queryDynSql" /> 
		<include refid="order" /> 
    </select>  
    <!-- 日账单-下载系统账单信息 -->
    <select id="queryDownloadSysBillList"  parameterType="com.froad.agre.modules.bill.vo.req.BillQueryVoReq" resultType="com.froad.agre.modules.bill.vo.resp.DownloadSysBillVoResp">
   	    SELECT
		    fob.CHN_PAY_NO         AS chnPayNo,
		    fob.ORDER_ID           AS orderId,
		    fm.MERCHANT_FULLNAME   AS merchantFullname,
		    fmo.OUTLET_NAME        AS outletName,
		    fob.PAY_CHANNEL        AS payChannel,
		    fo.TYPE                AS tradeType,
		    fob.TYPE               AS billType,
		    to_char(fob.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss')        AS createTime,
		    to_char(fob.UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss')        AS updateTime,
		    fob.AMOUNT             AS amount,
		    fob.PAY_CHANNEL_CHARGE AS payChannelCharge,
		    fob.BANK_CHARGE        AS bankCharge,
		    fob.BANK_RECEIPTS      AS bankReceipts,
		    fob.MERCHANT_RECEIPTS  AS merchantReceipts,
		    fob.PAYER_ACCOUNT      AS payerAccount,
		    fo.TERMINAL_ID         AS terminalId,
		    forg.org_name          AS orgName
			<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		        FROM FR_ORDER_BILL fob
			    LEFT JOIN FR_ORDER fo ON 
		   </if>
		    <if test='queryType=="2"'>
		        FROM FR_ORDER_BILL_NINETY fob
			    LEFT JOIN FR_ORDER_NINETY fo ON 
		   </if>
		    <if test='queryType=="3"'>
		        FROM FR_ORDER_BILL_HIS fob
			    LEFT JOIN FR_ORDER_HIS fo ON 
		   </if>
		 </if>
		fo.ORDER_ID=fob.ORDER_ID
		LEFT JOIN
		    FR_MERCHANT fm
		ON
		    fm.MERCHANT_ID=fo.MERCHANT_ID
		LEFT JOIN
		    FR_MERCHANT_OUTLET fmo
		ON
		    fo.OUTLET_ID = fmo.OUTLET_ID
		LEFT JOIN
		    FR_ORG forg
		ON
		    fo.THE_ORG_CODE=forg.ORG_CODE
		WHERE
		    to_char(fob.CREATE_TIME,'YYYY-MM-DD')=#{createTime}
		AND fob.PAY_CHANNEL=#{payChannel} and fob.IS_DZ = #{isDz}
    	ORDER BY FOB.CREATE_TIME DESC
    </select>
    
    <!-- 下载微信对账单 -->
    <select id="queryWechantBillList" parameterType="com.froad.agre.modules.bill.vo.req.DownloadSysBillVoReq" resultType="com.froad.agre.modules.bill.vo.resp.DownloadBillWechatVoResp">
			SELECT  
			to_char(we.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS createTime,
			to_char(we.UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS updateTime,
			we.BILL_TYPE AS billType,
			to_char(we.TRAN_DATE,'yyyy-MM-dd HH24:mi:ss') AS tranDate,
			we.OPEN_ID AS openId,
			we.MERCHANT_ID AS merchantId,
			we.SUB_MERCHANT_ID AS subMerchantId,
			we.MACHINE_ID AS machineId,
			we.WX_ORDER_ID AS wxOrderId,
			we.ORDER_ID AS orderId,
			we.USER_ID AS userId,
			we.TRAN_TYPE AS tranType,
			we.TRAN_STATUS AS tranStatus,
			we.PAY_BANK AS payBank,
			we.AMOUNT AS amount,
			we.FAV_AMOUNT AS favAmount,
			we.WX_REFUND_ID AS wxRefundId,
			we.REFUND_ID AS refundId,
			we.REFUND_AMOUNT AS refundAmount,
			we.REFUND_FAV_AMOUNT AS refundFavAmount,
			we.REFUND_TYPE AS refundType,
			we.REFUND_STATUS AS refundStatus,
			we.PRODUCT_NAME AS productName,
			we.CHARGE AS charge,
			we.RATE AS rate,
			we.IS_DZ AS isDz,
			to_char(we.DZ_TIME,'yyyy-MM-dd HH24:mi:ss') AS dzTime
			<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		        FROM FR_WECHAT_DZ we
		   </if>
		    <if test='queryType=="3"'>
		        FROM FR_WECHAT_DZ_HIS we
		   </if>
		 </if>
			WHERE to_char(we.TRAN_DATE,'YYYY-MM-DD') =#{createTime}
    </select>  
    
    <!--  下载支付宝对账单 -->
    <select id="queryAipayBillList" parameterType="com.froad.agre.modules.bill.vo.req.DownloadSysBillVoReq" resultType="com.froad.agre.modules.bill.vo.resp.DownloadBillAlipayVoResp">
		    SELECT 
			to_char(al.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS createTime,
			to_char(al.UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS updateTime,
			al.TRAN_TYPE AS billType,
			to_char(al.BILL_DATE,'yyyy-MM-dd HH24:mi:ss') AS billDate,
			al.ALIPAY_ID AS alipayId,
			al.ORDER_ID AS orderId,
			al.TRAN_TYPE AS tranType,
			al.PRODUCT_NAME AS productName,
			to_char(al.TRAN_DATE,'yyyy-MM-dd HH24:mi:ss') AS tranDate,
			al.OUTLET_ID AS outletId,
			al.OUTLET_NAME AS outletName,
			al.MACHINE_ID AS merchantId,
			al.PAYEE_NO AS payeeNo,
			al.AMOUNT AS amount,
			al.PAID_AMOUNT AS paidAmount,
			al.REFUND_BATCH_ID AS refundBatchId,
			al.CHARGE AS charge,
			al.IS_DZ AS isDz,
			to_char(al.DZ_TIME,'yyyy-MM-dd HH24:mi:ss') AS dzTime
			<if test="queryType!=null and queryType!='' ">
		    <if test='queryType=="1"'>
		        FROM FR_ALIPAY_DZ al
		   </if>
		    <if test='queryType=="3"'>
		        FROM FR_ALIPAY_DZ_HIS al
		   </if>
		 </if>
			WHERE to_char(al.TRAN_DATE,'YYYY-MM-DD')=#{createTime}
    </select>
    
    <!-- 下载积分对账单 -->
    <select id="queryBankPointBillList" parameterType="com.froad.agre.modules.bill.vo.req.DownloadSysBillVoReq" resultType="com.froad.agre.modules.bill.vo.resp.DownloadBillBankPointVoResp">
		    SELECT 
			to_char(fp.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS createTime,
			to_char(fp.UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS updateTime,
			fp.CHANNEL_ID AS channelId,
			to_char(fp.SETTLE_DATE,'yyyy-MM-dd HH24:mi:ss') AS settleDate,
			fp.ORDER_ID AS orderId,
			to_char(fp.TRAN_DATE,'yyyy-MM-dd HH24:mi:ss') AS tranDate,
			fp.BANK_SEQ AS bankSeq,
			to_char(fp.BANK_TIME,'yyyy-MM-dd HH24:mi:ss') AS bankTime,
			fp.LINK_POINT_SEQ AS linkPointSeq,
			to_char(fp.LINK_POINT_TIME,'yyyy-MM-dd HH24:mi:ss') AS linkPointTime,
			fp.USER_ID AS UserId,
			fp.TRAN_TYPE AS tranType,
			fp.TRAN_POINT AS tranPoint,
			fp.IS_DZ AS isDz,
			to_char(fp.DZ_TIME,'yyyy-MM-dd HH24:mi:ss') AS dzTime,
			fp.BATCH_ID AS batchId,
			fp.REMARK AS remark
			FROM FR_BANK_POINT_DZ fp
			WHERE to_char(fp.TRAN_DATE,'YYYY-MM-DD')=#{createTime}
    </select>
    
    <!-- 下载快捷对账单 -->
    <select id="queryBankOrderBillList" parameterType="com.froad.agre.modules.bill.vo.req.DownloadSysBillVoReq" resultType="com.froad.agre.modules.bill.vo.resp.DownloadBillBankOrderVoResp">
		    SELECT 
			to_char(fo.CREATE_TIME,'yyyy-MM-dd HH24:mi:ss') AS createTime,
			to_char(fo.UPDATE_TIME,'yyyy-MM-dd HH24:mi:ss') as updateTime,
			fo.ORDER_ID AS orderId,
			fo.BANK_SEQ AS bankSeq,
			to_char(fo.TRAN_DATE,'yyyy-MM-dd HH24:mi:ss') AS tranDate,
			fo.TRAN_TYPE AS tranType,
			fo.PROTOCOL_NO AS protocolNo,
			fo.TRAN_FEE AS tranFee,
			fo.TRAN_AMOUNT AS tranAmount,
			fo.CCY_CODE AS ccyCode,
			fo.LINK_ORDER_ID AS linkOrderId,
			to_char(fo.LINK_TRAN_TIME,'yyyy-MM-dd HH24:mi:ss') AS linkTranTime,
			fo.TRAN_STATUS AS tranStatus,
			fo.FAIL_RESULT AS failResult,
			fo.PAYMENT_ORG AS paymentOrg,
			fo.PAYMENT_SEQ AS paymentSeq,
			fo.IS_DZ AS isDz,
			to_char(fo.DZ_TIME,'yyyy-MM-dd HH24:mi:ss') AS dzTime
			FROM FR_BANK_ORDER_DZ fo 
			WHERE to_char(fo.TRAN_DATE,'YYYY-MM-DD')=#{createTime}
    </select>
  </mapper>